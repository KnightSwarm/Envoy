<!doctype html>
<html>
	<head>
		<!-- Stylesheets -->
		<link rel="stylesheet" href="css/pure-min.css">
		<link rel="stylesheet" href="font-awesome/css/font-awesome.min.css">
		<link rel="stylesheet" href="css/main.css">
		<link rel="stylesheet" href="istok/stylesheet.css">
		<!-- Base Javascript libraries -->
		<script src="script/jquery-1.10.2.min.js"></script>
		<script src="script/jquery.shiftenter.js"></script>
		<script src="script/angular.min.js"></script>
		<script src="script/angular-scrollglue.js"></script>
		<script src="script/underscore-min.js"></script>
		<script src="script/moment-with-langs.min.js"></script>
		<script src="script/compat.js"></script>
		<!-- Initial configuration and Python availability detection -->
		<script type="text/python">
			import sys
			# Evil hack! Needs to be replaced...
			sys.path.insert(1, "/home/sven/projects/SleekXMPP/")
			has_python = True;
		</script>
		<!-- Components for TideSDK client -->
		<script type="text/python" src="script/queue.py"></script>
		<script type="text/python" src="script/client-tide.py"></script>
		<!-- Components and shims for web client -->
		<script src="script/shim.js"></script>
		<script src="script/client-web.js"></script>
		<!-- Universal application code -->
		<script src="script/menu.js"></script>
		<script src="script/ui.js"></script>
		<script src="script/client-all.js"></script>
		<script src="script/eventloop.js"></script>
	</head>
	<body ng-app="envoyClient" ng-controller="UiController">
		<div class="application" ng-show="data.logged_in == true">
			<!-- Left-hand "joined rooms" list -->
			<div id="room_list">
				<!-- Lobby -->
				<div class="room" ng-class="{selected : data.current_room == 'lobby'}" ng-click="data.current_room = 'lobby'" data-jid="lobby">
					<i class="status icon-list icon-fixed-width"></i>
					<span class="name">Room List</span>
					<div class="arrow"></div>
				</div>
				<!-- Actual rooms -->
				<div class="room" ng-class="{selected : data.current_room == room.jid}" ng-repeat="room in data.rooms" ng-click="data.current_room = room.jid" data-jid="{{ room.jid }}" ng-controller="RoomController">
					<i class="status icon-{{room.icon}} icon-fixed-width"></i>
					<span class="name">{{ room.name }}</span>
					<a href="#" class="close" ng-click="leave_room(room.jid); $event.stopPropagation();"><i class="icon-remove"></i></a>
					<div class="arrow"></div>
				</div>
			</div>
			<!-- Per-room user list -->
			<div id="user_list">
				<div class="list" ng-repeat="room in data.rooms" ng-class="{hidden : data.current_room != room.jid}" ng-controller="RoomController">
					<div class="user" ng-repeat="user in room.all_users">
						<i class="status {{user.status}} icon-circle"></i>
						{{ user.fullname }}
					</div>
				</div>
			</div>
			<!-- Chat message area -->
			<div id="main" scroll-glue>
				<!-- Lobby overview page -->
				<div class="lobby" ng-class="{hidden : data.current_room != 'lobby'}">
					<h1>Rooms</h1>
					<div class="room" ng-repeat="room in data.all_rooms" data-jid="{{ room.jid }}">
						<i class="status icon-{{room.icon}} icon-fixed-width"></i>
						<span class="name"><a href="#" ng-click="join_room(room.jid)">{{ room.name }}</a></span>
						<span class="description">{{ room.description }}</span>
					</div>
				</div>
				<!-- Actual chatroom pages -->
				<div class="chat" ng-repeat="room in data.rooms"  data-jid="{{ room.jid }}" ng-class="{hidden : data.current_room != room.jid}" ng-controller="RoomController">
					<div class="message" ng-repeat="message in room.all_messages" ng-class="{own : message.jid == own_jid}">
						<span class="timestamp">{{ format_time(message.timestamp) }}</span>
						<span ng-show="message.type == 'message'">
							<span class="author">{{ message.fullname }}</span>
							<span class="body">{{ message.body }}</span>
						</span>
						<span class="event" ng-show="message.type == 'event' && message.event == 'join'">
							{{ message.fullname }} joined the room.
						</span>
						<span class="event" ng-show="message.type == 'event' && message.event == 'leave'">
							{{ message.fullname }} left the room.
						</span>
						<div class="clear"></div>
					</div>
				</div>
			</div>
			<div class="input" ng-class="{hidden : data.current_room == 'lobby'}">
				<form ng-submit="send_message()" id="form_message">
					<textarea id="input_field" ng-model="data.input_message"></textarea>
					<button type="button" class="send" ng-click="send_message()">Send</button>
				</form>
			</div>
		</div>
		<div class="login" ng-show="data.logged_in == false">
			<div class="alert" ng-show="data.login_failed == true">
				<span ng-show="data.login_error == 'value'">Please enter your full JID, including domain.</span>
				<span ng-show="data.login_error == 'auth'">The login details you entered are incorrect.</span>
			</div>
			<form ng-submit="login()" class="loginform">
				<label>XMPP Address</label>
				<input type="text" ng-model="data.username">
				<label>Password</label>
				<input type="password" ng-model="data.password">
				<button type="submit" class="pure-button" ng-show="data.login_busy == false">Login</button>
				<div class="in-progress" ng-show="data.login_busy == true">
					<i class="icon-cog icon-spin icon-2x"></i>
				</div>
			</form>
		</div>
	</body>
</html>
